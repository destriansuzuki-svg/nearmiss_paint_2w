<!DOCTYPE html>
<html lang="id" x-data="appData()" x-init="initApp()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Painting 2W</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> [x-cloak] { display: none !important; } </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div x-show="!isLoggedIn" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-80 text-center">
            <h2 class="text-2xl font-black text-blue-600 mb-6 uppercase">Admin Login</h2>
            <div class="space-y-4">
                <input type="password" x-model="loginForm.pass" placeholder="Password" class="w-full p-3 border rounded-xl text-center outline-blue-600">
                <button @click="login()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">MASUK</button>
            </div>
        </div>
    </div>

    <div x-show="isLoggedIn" x-cloak class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-900 text-white flex flex-col transition-all">
            <div class="p-6 border-b border-slate-800"><h1 class="font-black text-blue-400">PAINTING 2W</h1></div>
            <nav class="flex-1 p-4 space-y-2">
                <button @click="page = 'dashboard'" :class="page === 'dashboard' ? 'bg-blue-600' : ''" class="flex w-full p-3 rounded-xl gap-3 font-bold"><i data-lucide="layout-dashboard"></i> Dashboard</button>
                <button @click="page = 'data-karyawan'" :class="page === 'data-karyawan' ? 'bg-blue-600' : ''" class="flex w-full p-3 rounded-xl gap-3 font-bold"><i data-lucide="users"></i> Data Karyawan</button>
                <button @click="page = 'data-nearmiss'" :class="page === 'data-nearmiss' ? 'bg-blue-600' : ''" class="flex w-full p-3 rounded-xl gap-3 font-bold"><i data-lucide="alert-triangle"></i> Data Nearmiss</button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            
            <div x-show="page === 'dashboard'" class="space-y-6">
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-slate-400 uppercase">Total Karyawan</p>
                        <h3 class="text-3xl font-black" x-text="karyawan.length"></h3>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-red-400 uppercase">Nearmiss Pending</p>
                        <h3 class="text-3xl font-black" x-text="nearmiss.filter(n => n.note !== 'Close').length"></h3>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-green-400 uppercase">Nearmiss Closed</p>
                        <h3 class="text-3xl font-black" x-text="nearmiss.filter(n => n.note === 'Close').length"></h3>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h4 class="font-black text-slate-800 mb-4 uppercase text-sm">Log Aktivitas Terbaru</h4>
                    <div class="space-y-3">
                        <template x-for="log in nearmiss.slice(0,5)" :key="log.when">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="font-bold text-xs" x-text="log.nama"></span>
                                <span class="text-[10px] text-slate-400" x-text="log.when"></span>
                                <span class="text-[10px] font-black uppercase text-blue-600" x-text="log.where"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div x-show="page === 'data-karyawan'" class="space-y-4">
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border">
                    <input type="text" x-model="searchKaryawan" placeholder="Cari NIK atau Nama..." class="p-2 bg-slate-50 border rounded-xl w-64 outline-blue-600 font-medium">
                    <button @click="openModalKaryawan()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold shadow-lg shadow-blue-200 text-sm">+ KARYAWAN</button>
                </div>
                <div class="bg-white rounded-2xl border overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900 text-white font-bold uppercase text-[10px]">
                            <tr><th class="p-4">No</th><th class="p-4">NIK</th><th class="p-4">Nama</th><th class="p-4 text-center">Aksi</th></tr>
                        </thead>
                        <tbody>
                            <template x-for="(k, idx) in filteredKaryawan" :key="k.nik">
                                <tr class="border-b hover:bg-slate-50">
                                    <td class="p-4 text-slate-400" x-text="idx + 1"></td>
                                    <td class="p-4 font-black text-blue-600" x-text="k.nik"></td>
                                    <td class="p-4 font-bold uppercase text-slate-700" x-text="k.nama"></td>
                                    <td class="p-4 text-center space-x-2">
                                        <button @click="editKaryawan(k)" class="p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                        <button @click="deleteData('karyawan', k)" class="p-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-600 hover:text-white transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="page === 'data-nearmiss'" class="space-y-4">
                <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border">
                    <input type="text" x-model="searchNearmiss" placeholder="Cari Nearmiss..." class="p-2 bg-slate-50 border rounded-xl w-64 outline-blue-600 font-medium">
                    <button @click="openModalNearmiss()" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-bold text-sm">+ LAPOR BARU</button>
                </div>
                <div class="bg-white rounded-2xl border overflow-x-auto">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-slate-900 text-white font-bold uppercase">
                            <tr><th class="p-4">Karyawan</th><th class="p-4">Waktu</th><th class="p-4">Lokasi</th><th class="p-4">Status</th><th class="p-4 text-center">Aksi</th></tr>
                        </thead>
                        <tbody>
                            <template x-for="(n, idx) in filteredNearmiss" :key="idx">
                                <tr class="border-b hover:bg-slate-50">
                                    <td class="p-4 font-bold"><div x-text="n.nik" class="text-blue-600"></div><div x-text="n.nama" class="uppercase"></div></td>
                                    <td class="p-4 font-medium" x-text="n.when"></td>
                                    <td class="p-4 font-medium" x-text="n.where"></td>
                                    <td class="p-4">
                                        <span :class="n.note === 'Close' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="px-3 py-1 rounded-full font-black text-[9px] uppercase" x-text="n.note"></span>
                                    </td>
                                    <td class="p-4 text-center space-x-2">
                                        <button @click="editNearmiss(n)" class="p-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                        <button @click="deleteData('nearmiss', n)" class="p-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-600 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div x-show="showModalKaryawan" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-3xl p-8 w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-black mb-6" x-text="isEdit ? 'EDIT KARYAWAN' : 'TAMBAH KARYAWAN'"></h3>
            <div class="space-y-4">
                <input type="text" x-model="formKaryawan.nik" placeholder="NIK" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold uppercase">
                <input type="text" x-model="formKaryawan.nama" placeholder="Nama Lengkap" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold uppercase">
                <div class="flex gap-2">
                    <button @click="showModalKaryawan = false" class="flex-1 py-3 font-bold text-slate-400">Batal</button>
                    <button @click="saveKaryawan()" class="flex-1 py-3 bg-blue-600 text-white font-black rounded-2xl">SIMPAN</button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showModalNearmiss" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm" x-cloak>
        <div class="bg-white rounded-[2rem] p-8 w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-black mb-6 uppercase" x-text="isEdit ? 'Update Laporan' : 'Laporan Baru'"></h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                    <select x-model="formNearmiss.nik" class="w-full p-3 bg-slate-50 border rounded-xl font-bold">
                        <option value="">-- Pilih NIK --</option>
                        <template x-for="k in karyawan"><option :value="k.nik" x-text="k.nik + ' - ' + k.nama"></option></template>
                    </select>
                </div>
                <input type="date" x-model="formNearmiss.when" class="p-3 bg-slate-50 border rounded-xl font-bold">
                <input type="text" x-model="formNearmiss.where" placeholder="Lokasi" class="p-3 bg-slate-50 border rounded-xl font-bold uppercase">
                <textarea x-model="formNearmiss.detail" placeholder="Detail Bahaya" class="col-span-2 p-3 bg-slate-50 border rounded-xl h-20"></textarea>
                <select x-model="formNearmiss.note" class="col-span-2 p-3 bg-slate-50 border rounded-xl font-black uppercase text-blue-600">
                    <option value="Belum Close">Belum Close (Pending)</option>
                    <option value="Close">Close (Selesai)</option>
                </select>
            </div>
            <div class="flex gap-4 mt-6">
                <button @click="showModalNearmiss = false" class="flex-1 py-3 font-bold text-slate-400">Batal</button>
                <button @click="saveNearmiss()" class="flex-1 py-3 bg-blue-600 text-white font-black rounded-2xl">SUBMIT DATA</button>
            </div>
        </div>
    </div>

    <script>
    function appData() {
        return {
            isLoggedIn: false, page: 'dashboard', isSyncing: false, isEdit: false,
            searchKaryawan: '', searchNearmiss: '',
            scriptURL: 'ISI_URL_WEBAPP_ANDA_DISINI',
            karyawan: [], nearmiss: [],
            loginForm: { pass: '' },
            formKaryawan: { nik: '', nama: '' },
            formNearmiss: { nik: '', nama: '', when: '', where: '', detail: '', note: 'Belum Close' },
            showModalKaryawan: false, showModalNearmiss: false, originalData: null,

            async initApp() { await this.syncAll(); },

            async syncAll() {
                this.isSyncing = true;
                try {
                    const r = await fetch(this.scriptURL + "?t=" + Date.now());
                    const d = await r.json();
                    this.karyawan = d.karyawan.map(i => ({ nik: String(i[0]), nama: String(i[1]) }));
                    this.nearmiss = d.nearmiss.map(i => ({ nik: String(i[0]), nama: String(i[1]), when: String(i[2]), where: String(i[3]), detail: String(i[4]), note: String(i[7]) })).reverse();
                } catch (e) { console.log("Gagal Sync"); }
                finally { this.isSyncing = false; lucide.createIcons(); }
            },

            get filteredKaryawan() {
                return this.karyawan.filter(k => k.nama.toLowerCase().includes(this.searchKaryawan.toLowerCase()) || k.nik.includes(this.searchKaryawan));
            },

            get filteredNearmiss() {
                return this.nearmiss.filter(n => n.nama.toLowerCase().includes(this.searchNearmiss.toLowerCase()) || n.where.toLowerCase().includes(this.searchNearmiss.toLowerCase()));
            },

            openModalKaryawan() { this.isEdit = false; this.formKaryawan = { nik: '', nama: '' }; this.showModalKaryawan = true; },
            
            editKaryawan(item) { this.isEdit = true; this.originalData = { nik: item.nik }; this.formKaryawan = { ...item }; this.showModalKaryawan = true; },

            editNearmiss(item) { this.isEdit = true; this.originalData = { nik: item.nik, when: item.when }; this.formNearmiss = { ...item }; this.showModalNearmiss = true; },

            async deleteData(type, item) {
                if(!confirm("Yakin hapus data ini?")) return;
                const fd = new URLSearchParams();
                fd.append('type', type); fd.append('action', 'delete'); fd.append('nik', item.nik);
                if(type === 'nearmiss') fd.append('when', item.when);
                await fetch(this.scriptURL, { method: 'POST', body: fd, mode: 'no-cors' });
                this.syncAll();
            },

            async saveKaryawan() {
                const fd = new URLSearchParams();
                fd.append('type', 'karyawan');
                if(this.isEdit) { fd.append('action', 'update'); fd.append('oldNik', this.originalData.nik); }
                fd.append('nik', this.formKaryawan.nik); fd.append('nama', this.formKaryawan.nama);
                await fetch(this.scriptURL, { method: 'POST', body: fd, mode: 'no-cors' });
                this.showModalKaryawan = false; this.syncAll();
            },

            async saveNearmiss() {
                const k = this.karyawan.find(i => i.nik === this.formNearmiss.nik);
                if(!k) return alert("Pilih Karyawan!");
                this.formNearmiss.nama = k.nama;
                const fd = new URLSearchParams();
                fd.append('type', 'nearmiss');
                if(this.isEdit) { fd.append('action', 'update'); fd.append('oldNik', this.originalData.nik); fd.append('oldWhen', this.originalData.when); }
                for(let key in this.formNearmiss) fd.append(key, this.formNearmiss[key]);
                await fetch(this.scriptURL, { method: 'POST', body: fd, mode: 'no-cors' });
                this.showModalNearmiss = false; this.syncAll();
            },

            login() { if(this.loginForm.pass === 'admin') this.isLoggedIn = true; }
        }
    }
    </script>
</body>
</html>
