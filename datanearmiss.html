<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Nearmiss - Painting 2W</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .sidebar-active {
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
            color: white !important;
        }
    </style>
</head>
<body x-data="appData()" x-init="initApp()">

    <div class="flex h-screen overflow-hidden">
        <aside :class="sidebarOpen ? 'w-72' : 'w-20'" class="bg-[#0f172a] text-white transition-all duration-300 flex flex-col z-50">
            <div class="p-8 flex items-center justify-between">
                <h1 x-show="sidebarOpen" class="font-black text-xl tracking-tighter italic">
                    <span class="text-blue-500">PAINTING</span><span class="text-white">2W</span>
                </h1>
                <button @click="sidebarOpen = !sidebarOpen" class="text-slate-400 hover:text-white">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <a href="dashboard.html" class="flex items-center w-full p-4 rounded-2xl text-slate-400 hover:bg-slate-800 transition-all font-bold group">
                    <i data-lucide="layout-grid" class="w-6 h-6"></i>
                    <span x-show="sidebarOpen" class="ml-4 text-sm tracking-widest uppercase">Dashboard</span>
                </a>
                
                <a href="datanearmiss.html" class="flex items-center w-full p-4 rounded-2xl sidebar-active font-bold">
                    <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    <span x-show="sidebarOpen" class="ml-4 text-sm tracking-widest uppercase">Nearmiss</span>
                </a>

                <a href="datakaryawan.html" class="flex items-center w-full p-4 rounded-2xl text-slate-400 hover:bg-slate-800 transition-all font-bold group">
                    <i data-lucide="users" class="w-6 h-6"></i>
                    <span x-show="sidebarOpen" class="ml-4 text-sm tracking-widest uppercase">Karyawan</span>
                </a>
            </nav>

            <div class="p-8">
                <button @click="logout()" class="flex items-center text-red-400 font-bold hover:text-red-300 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span x-show="sidebarOpen" class="ml-3 text-sm uppercase tracking-widest">Keluar</span>
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col min-w-0 bg-[#f8fafc]">
            <header class="bg-white px-10 py-6 flex justify-between items-center shadow-sm">
                <h2 class="text-2xl font-extrabold text-slate-800 italic uppercase tracking-tight">Laporan Nearmiss</h2>
                <div class="bg-slate-100 px-6 py-2 rounded-full flex items-center gap-3 text-slate-500 font-bold text-xs shadow-inner">
                    <i data-lucide="refresh-cw" class="w-4 h-4" :class="isSyncing ? 'animate-spin' : ''"></i>
                    <span x-text="isSyncing ? 'SYNCING...' : 'SINKRON...'"></span>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-10">
                <div class="max-w-[1600px] mx-auto space-y-10">
                    
                    <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 flex flex-wrap lg:flex-nowrap items-center gap-6">
                        <div class="relative flex-1 min-w-[300px]">
                            <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5"></i>
                            <input type="text" x-model="searchQuery" placeholder="Cari NIK, Nama, atau Lokasi..." 
                                   class="w-full pl-16 pr-8 py-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 ring-blue-500/10 font-medium text-slate-600">
                        </div>
                        
                        <div class="flex bg-slate-100 p-1.5 rounded-2xl gap-1">
                            <button @click="currentFilter = 'all'" :class="currentFilter === 'all' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'" class="px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter transition-all">Semua</button>
                            <button @click="currentFilter = 'open'" :class="currentFilter === 'open' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'" class="px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter transition-all">Pending</button>
                            <button @click="currentFilter = 'close'" :class="currentFilter === 'close' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'" class="px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter transition-all">Closed</button>
                        </div>

                        <button @click="openModal()" class="bg-[#111827] text-white px-8 py-4 rounded-2xl font-black text-[11px] tracking-widest hover:bg-blue-600 transition-all uppercase shadow-lg shadow-slate-200">
                            + Lapor Online
                        </button>
                    </div>

                    <div class="bg-white rounded-[3rem] shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto p-6">
                            <table class="w-full border-separate border-spacing-0">
                                <thead>
                                    <tr class="bg-[#1e293b] text-white">
                                        <th class="p-6 pl-10 rounded-l-full text-[10px] font-black uppercase tracking-widest text-left">NIK / Nama</th>
                                        <th class="p-6 text-[10px] font-black uppercase tracking-widest text-center">Tanggal</th>
                                        <th class="p-6 text-[10px] font-black uppercase tracking-widest text-left">Lokasi / Detail</th>
                                        <th class="p-6 text-[10px] font-black uppercase tracking-widest text-left">Countermeasure</th>
                                        <th class="p-6 text-[10px] font-black uppercase tracking-widest text-center">Status</th>
                                        <th class="p-6 pr-10 rounded-r-full text-[10px] font-black uppercase tracking-widest text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody class="text-xs font-bold text-slate-600">
                                    <template x-for="(n, idx) in filteredNearmiss" :key="idx">
                                        <tr class="hover:bg-slate-50 transition-colors group">
                                            <td class="p-6 pl-10 border-b border-slate-50">
                                                <div class="text-blue-600 font-black" x-text="n.nik"></div>
                                                <div class="text-slate-400 text-[10px] uppercase" x-text="n.nama"></div>
                                            </td>
                                            <td class="p-6 text-center border-b border-slate-50 text-slate-400" x-text="n.when || n.tanggal || '-'"></td>
                                            <td class="p-6 border-b border-slate-50">
                                                <div class="uppercase tracking-tighter" x-text="n.where || n.lokasi || '-'"></div>
                                                <div class="text-slate-400 font-medium normal-case line-clamp-1 italic" x-text="n.detail || n.temuan || '-'"></div>
                                            </td>
                                            <td class="p-6 border-b border-slate-50 max-w-xs truncate font-medium text-slate-400" x-text="n.measure || n.tindakan || '-'"></td>
                                            <td class="p-6 text-center border-b border-slate-50">
                                                <span :class="(n.note === 'Close' || n.status === 'Close') ? 'text-emerald-500' : 'text-red-500'" 
                                                      class="font-black text-[10px] uppercase" 
                                                      x-text="(n.note === 'Close' || n.status === 'Close') ? 'Closed' : 'Pending'"></span>
                                            </td>
                                            <td class="p-6 pr-10 text-center border-b border-slate-50">
                                                <div class="flex gap-2 justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button @click="editNearmiss(n)" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                                    <button @click="deleteNearmiss(n)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="filteredNearmiss.length === 0">
                                        <td colspan="6" class="p-20 text-center">
                                            <div class="flex flex-col items-center opacity-20">
                                                <i data-lucide="database" class="w-16 h-16 mb-4"></i>
                                                <p class="font-black uppercase tracking-widest text-sm">Data Tidak Ditemukan</p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        const SPREADSHEET_API = "https://script.google.com/macros/s/AKfycbyiDWiXNU5YSxjaChZlCsXKe8JfzyWKZuGoAvGjDUQSezgeIf4kySfsd0BCEQnNlnJAJw/exec";
        function appData() {
            return {
                sidebarOpen: true, isSyncing: false, searchQuery: '', currentFilter: 'all',
                nearmiss: [], modalNearmiss: false, isEdit: false,
                formN: { nik: '', nama: '', when: '', where: '', detail: '', measure: '', note: 'Open' },
                async initApp() { lucide.createIcons(); await this.loadData(); },
                async loadData() {
                    this.isSyncing = true;
                    try {
                        const r = await fetch(`${SPREADSHEET_API}?t=${Date.now()}`);
                        const d = await r.json();
                        this.nearmiss = d.nearmiss || [];
                    } finally { this.isSyncing = false; setTimeout(() => lucide.createIcons(), 100); }
                },
                get filteredNearmiss() {
                    return this.nearmiss.filter(n => {
                        const s = this.searchQuery.toLowerCase();
                        const match = (n.nama?.toLowerCase().includes(s)) || (n.nik?.toString().includes(s));
                        if(this.currentFilter === 'all') return match;
                        const status = (n.note || n.status || 'Open').toLowerCase();
                        return match && (this.currentFilter === status);
                    });
                }
            }
        }
    </script>
</body>
</html>
